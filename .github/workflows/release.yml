name: Build Release Binaries

on:
    workflow_dispatch:
    release:
        types: [published]

jobs:
    build-release:
        name: release ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-musl
                      os: ubuntu-latest
                      cross: true
                    - target: aarch64-unknown-linux-musl
                      os: ubuntu-latest
                      cross: true

        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@1.87.0
              with:
                  target: ${{ matrix.target }}

            - name: Run Cross
              if: ${{ matrix.cross }}
              run: |
                  cargo install cross --git https://github.com/cross-rs/cross.git --locked --rev 085092ca
                  cross build --release --target ${{ matrix.target }}

            - name: Run Cargo
              if: ${{ !matrix.cross }}
              run: cargo build --release --target ${{ matrix.target }}

            - name: create artifact directory
              shell: bash
              run: |
                  directory=stormwind-${{ matrix.target }}
                  mkdir $directory
                  cp README.md LICENSE NOTICE $directory
                  cp target/${{ matrix.target }}/release/stormwind $directory
                  tar cJf $directory.tar.xz $directory

            - uses: actions/upload-artifact@v4
              if: github.event_name == 'workflow_dispatch'
              with:
                  name: stormwind-${{ matrix.target }}
                  path: "stormwind-${{ matrix.target }}.*"
                  retention-days: 3
